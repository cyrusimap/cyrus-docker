#!/usr/bin/perl
use v5.36.0;
use Path::Tiny;
use Process::Status;

unless (-e '/run/rsyslogd.pid') {
  system('/usr/sbin/rsyslogd');
  Process::Status->assert_ok('starting rsyslog');
}

my $root = "/srv/cyrus-imapd/cassandane";
chdir $root or die "can't chdir to $root: $!";

unless (-e "cassandane.ini") {
  system(qw(cp -af cassandane.ini.dockertests cassandane.ini));
  Process::Status->assert_ok('copying cassandane.ini.dockertests to cassandane.ini');

  system(qw(chown cyrus:mail cassandane.ini));
  Process::Status->assert_ok('chowning cassandane.ini');
}

# XXX This is transitional, while we haven't updated cyrus-imap.git to
# eliminate the .git in path names that existed prior to recent commits.
{
  my @lines = path('cassandane.ini')->lines;
  s{/srv/[-A-Za-z]+\K.git}{}g for @lines;
  path('cassandane.ini')->spew(@lines);
}

# XXX This is transitional, while we haven't updated cyrus-imap.git to
# eliminate the .git in path names that existed prior to recent commits.
{
  my @lines = path('cassandane.ini')->lines;
  s{/srv/[-A-Za-z]+\K.git}{}g for @lines;
  path('cassandane.ini')->spew(@lines);
}

system(qw(make -j 12));
Process::Status->assert_ok('Cassandane make');

my @opts = $ENV{CASSANDANEOPTS} ? $ENV{CASSANDANEOPTS} : ();

system(
  qw(
    setpriv --reuid=cyrus --regid=mail
            --clear-groups --inh-caps=-all
            ./testrunner.pl -f pretty -j 12
  ),
  @opts,
);

Process::Status->assert_ok('Cassandane run');
