#!/usr/bin/perl
use v5.36.0;

unless (-e '/run/rsyslogd.pid') {
  system('/usr/sbin/rsyslogd');
  if ($?) { die "problems starting rsyslogd\n"; }
}

my $root = "/srv/cyrus-imapd/cassandane";
chdir $root or die "can't chdir to $root: $!";

unless (-e "cassandane.ini") {
  system(qw(cp -af cassandane.ini.dockertests cassandane.ini));
  if ($?) { die "problems copying cassandane.ini.dockertests to cassandane.ini\n"; }

  system(qw(chown cyrus:mail cassandane.ini));
  if ($?) { die "problems chowning cassandane.ini\n"; }
}

system(qw(make));
if ($?) { die "Cassandane make failed\n"; }

my @opts = $ENV{CASSANDANEOPTS} ? $ENV{CASSANDANEOPTS} : ();

system(
  qw(
    setpriv --reuid=cyrus --regid=mail 
            --clear-groups --inh-caps=-all
            ./testrunner.pl -f pretty -j 4
  ),
  @opts,
);

if ($?) { die "Cassandane run failed\n"; }
